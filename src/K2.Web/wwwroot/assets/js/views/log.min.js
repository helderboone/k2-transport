var Log=function(){var o=function(){App.bloquear();$("#tblLog").DataTable({ajax:{url:App.corrigirPathRota("listar-log"),type:"POST",error:function(n){var t=Feedback.converter(n.responseJSON);t.exibirModal()},data:function(n){n.DataInicio=$("#iProcurarDataSaidaInicio").val();n.DataFim=$("#iProcurarDataSaidaFim").val();n.Tipo=$("#sProcurarTipo").val();n.Mensagem=$("#iProcurarMensagem").val();n.Usuario=$("#iProcurarUsuario").val();n.NomeOrigem=$("#iProcurarOrigem").val();n.ExceptionInfo=$("#iProcurarExceptionInfo").val()}},info:!0,columns:[{data:"dataToString",title:"Data",width:"1px",orderable:!0,className:"all"},{data:null,className:"m--align-center",orderable:!0,width:"1px",createdCell:function(n,t){switch(t.tipo){case"Information":$(n).addClass("bg-info m--font-light m--font-bolder");$(n).html("Info");break;case"Warning":$(n).addClass("bg-warning m--font-bolder");$(n).html("Atenção");break;case"Error":$(n).addClass("bg-danger m--font-light m--font-bolder");$(n).html("Erro")}}},{data:"mensagem",title:"Mensagem",orderable:!0},{data:"usuario",title:"Usuário",orderable:!0},{data:"nomeOrigem",title:"Origem",orderable:!0},{data:null,className:"td-actions dt-center all",orderable:!1,width:"70px",render:function(n,t,i){return'<a href="#" data-id="'+i.id+'" class="detalhar-log m-portlet__nav-link btn m-btn m-btn--hover-brand m-btn--icon m-btn--icon-only m-btn--pill" data-container="body" data-toggle="m-tooltip" data-placement="left" title="" data-original-title="Detalhar"><i class="la la-search"><\/i><\/a><a href="#" data-id="'+i.id+'" class="excluir-log m-portlet__nav-link btn m-btn m-btn--hover-danger m-btn--icon m-btn--icon-only m-btn--pill" data-container="body" data-toggle="m-tooltip" data-placement="left" title="" data-original-title="Excluir"><i class="la la-trash"><\/i><\/a>'}}],select:{style:"single",info:!1},serverSide:!0,responsive:!0,pagingType:"full_numbers",order:[0,"desc"],searching:!1,paging:!0,lengthChange:!1,pageLength:15}).on("draw.dt",function(){mApp.initTooltips();$("a[class*='detalhar-log']").each(function(){var n=$(this).data("id");$(this).click(function(){h(n)})});$("a[class*='excluir-log']").each(function(){var n=$(this).data("id");$(this).click(function(){App.exibirConfirm("Deseja realmente excluir esse registro?","Sim","Não",function(){c(n)})})})}).on("processing.dt",function(){App.bloquear()})},s=function(){$("#frmProcurarLog").validate({submitHandler:function(){$("#tblLog").DataTable().ajax.reload()}})},h=function(n){App.exibirModalPorRota(App.corrigirPathRota("detalhar-log/"+n),function(){mApp.initComponents()})},c=function(n){App.bloquear();$.post(App.corrigirPathRota("excluir-log/"+n),function(n){var t=Feedback.converter(n);t.Tipo.Nome==Tipo.Sucesso?t.exibirModal(function(){$("#tblLog").DataTable().ajax.reload();App.ocultarModal()}):t.exibirModal()}).fail(function(n){var t=Feedback.converter(n.responseJSON);t.exibirModal()})},i=null,r=null,n=[],u=0,t=0,f=0,l=function(){let f="https://slack.com/api/groups.history?token="+i+"&count=1000&channel="+r;$.get(f,function(i){try{if(i==null){let n=new Feedback(3,"Ocorreu um erro ao excluir os registros do Slack.","A API do Slack não retornou uma resposta.");n.exibirModal();return}if(i.ok){if(i.messages.length==0){let n=new Feedback(2,"Nenhuma mensagem foi encontrada.");n.exibirModal();return}for(var r=0;r<i.messages.length;r++)n.push(i.messages[r].ts);u=n.length;App.desbloquear();$("#labelProgress").html("Serão excluídas, "+n.length+" mensagens.");$("#modal_Progress").modal({show:!0,backdrop:"static",keyboard:!1}).on("shown.bs.modal",function(){t=0;e()})}else{let n=new Feedback(3,"Ocorreu um erro ao excluir os registros do Slack.","A API do Slack retornou o seguinte código de erro: <b>"+i.error+"<\/b>");n.exibirModal();return}}catch(f){let n=new Feedback(3,"Ocorreu um erro ao excluir os registros do Slack.",f);n.exibirModal();App.desbloquear()}})},e=function(){if(n.length==0){let n=new Feedback(4,"Todas as mensagens foram excluídas com sucesso.");n.exibirModal(function(){$("#modal_Progress").modal("hide")});return}let o=n.shift(),s="https://slack.com/api/chat.delete?token="+i+"&channel="+r+"&ts="+o;f=parseInt(t*100/u);$("#labelProgress").html("Excluindo mensagem "+t+" de "+u+"...");$(".progress-bar").width(f+"%");$.get(s,function(i){if(i!=null&&i.ok)t++;else{if(i!=null&&!i.ok){let n=new Feedback(3,"Ocorreu um erro ao excluir os registros do Slack.","A API do Slack retornou o seguinte código de erro: <b>"+i.error+"<\/b>");n.exibirModal();return}n.push(o);t--}});setTimeout(e,1e3)};return{init:function(){o();$("#sProcurarTipo").select2({placeholder:"Selecione um tipo",allowClear:!0});$("#iProcurarPeriodoSaida").daterangepicker({buttonClasses:"m-btn btn",applyClass:"btn btn-sm m-btn--square btn-info",cancelClass:"btn btn-sm m-btn--square btn-secondary",parentEl:"#modal_Procurar",minDate:moment().startOf("year"),maxDate:moment().subtract(1,"days"),locale:{format:"DD/MM/YYYY",applyLabel:"Aplicar",cancelLabel:"Cancelar",daysOfWeek:["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"],monthNames:["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"]}},function(n,t){$("#iProcurarPeriodoSaida .form-control").val(n.format("DD/MM/YYYY")+" até "+t.format("DD/MM/YYYY"));$("#iProcurarDataSaidaInicio").val(n.format("DD/MM/YYYY"));$("#iProcurarDataSaidaFim").val(t.format("DD/MM/YYYY"))});$("#iProcurarPeriodoSaida").on("cancel.daterangepicker",function(){$("#iProcurarPeriodoSaida .form-control").val("");$("#iProcurarDataSaidaInicio").val("");$("#iProcurarDataSaidaFim").val("")});$("#bProcurar").click(function(){s()});$("#bLimparLog").click(function(){App.exibirConfirm("Deseja realmente limpar todos os registros do log no banco de dados?","Sim","Não",function(){$.post(App.corrigirPathRota("limpar-log"),function(n){var t=Feedback.converter(n);t.Tipo.Nome==Tipo.Sucesso?t.exibirModal(function(){$("#tblLog").DataTable().ajax.reload();App.ocultarModal()}):t.exibirModal()}).fail(function(n){var t=Feedback.converter(n.responseJSON);t.exibirModal()})})});$("#bLimparSlack").click(function(){i=$(this).data("token");r=$(this).data("channel-id");App.exibirConfirm("Deseja realmente limpar todos os registros do canal no Slack?","Sim","Não",function(){l()})})}}}();jQuery(document).ready(function(){Log.init()});